import streamlit as st
from docx import Document
from PyPDF2 import PdfReader
import tempfile
import os

st.set_page_config(page_title="ููุตุฉ ุฅุนุฏุงุฏ ุงูุนุฑูุถ - ูุชูุงุฒู", layout="centered")
st.title("๐ ููุตุฉ ุฅุนุฏุงุฏ ุงูุนุฑูุถ - ูุชูุงุฒู")
st.markdown("ูู ุจุฑูุน ูุฑุงุณุฉ ุงูุดุฑูุท ูุณูุชู ุชูููุฏ ุนุฑุถ ููู ุงุญุชุฑุงูู")

uploaded_file = st.file_uploader("๐ค ุงุฑูุน ูุฑุงุณุฉ ุงูุดุฑูุท (PDF)", type=["pdf"])
project_name = st.text_input("๐ ุงุณู ุงููุดุฑูุน")
client_name = st.text_input("๐๏ธ ุงุณู ุงูุฌูุฉ")
gov_logo = st.file_uploader("๐๏ธ ุดุนุงุฑ ุงูุฌูุฉ ุงูุญููููุฉ (ุงุฎุชูุงุฑู)", type=["png", "jpg"])

# ุงุณุชุฎุฑุงุฌ ุงููุต ูู PDF
@st.cache_data
def extract_text_from_pdf(file):
    reader = PdfReader(file)
    text = ""
    for page in reader.pages:
        text += page.extract_text() + "\n"
    return text

# ุชูููุฏ ุงูุนุฑุถ ุงูููู ุจุงุณุชุฎุฏุงู ูููุฐุฌ ูุถููู ูุญูููุง
from textwrap import dedent

def generate_proposal(content, project, client):
    template = dedent(f"""
    ุงูุนุฑุถ ุงูููู ููุดุฑูุน: {project}
    ุงูุฌูุฉ: {client}

    ูู ูุญู:
    ุดุฑูุฉ ูุชูุงุฒู ููุงุณุชุดุงุฑุงุชุ ูุชุฎุตุตุฉ ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุชุญูู ุงูุฑููู.

    ุฑุคูุชูุง:
    ุฃู ูููู ุงูุดุฑูุฉ ุงูุฑุงุฆุฏุฉ ูู ุชูุฏูู ุญููู ุงูุฐูุงุก ุงูุงุตุทูุงุนู ุงูููุซููุฉ ูู ุงูููููุฉ.

    ุฑุณุงูุชูุง:
    ุชูููู ุงูุฌูุงุช ูู ุชุญููู ุงูุชุญูู ุงููุนุงู ูู ุฎูุงู ุญููู ูุชูุฏูุฉ ููุนุงููุฑ ุฏูููุฉ.

    ุฎุฏูุงุชูุง:
    ุชุทููุฑ ุงูุณูุงุณุงุชุ ุชูููู ุงููุฎุงุทุฑุ ุจูุงุก ุงูุฃูุธูุฉ ุงูุฐููุฉุ ุงูุชุฏุฑูุจุ ูููุงุกูุฉ ุงููุนุงููุฑ.

    ููู ุงููุดุฑูุน:
    ุจูุงุกู ุนูู ูุฑุงุณุฉ ุงูุดุฑูุทุ ูููู ุฃู ุงูุฌูุฉ ุชุณุนู ุฅูู ุชุญููู ุงูุฃูุฏุงู ุงูุชุงููุฉ:
    {content[:500]}...

    ุฃูุฏุงู ุงููุดุฑูุน:
    - ุชุญููู ุฃูุฏุงู ุงูุฌูุฉ ูู ูุฌุงูุงุช ุงูุฐูุงุก ุงูุงุตุทูุงุนู ูุงูุชุญูู ุงููุคุณุณู.

    ูุทุงู ุงูุนูู ูุงููุณุคูููุงุช:
    - ุฏุฑุงุณุฉ ุงููุถุน ุงูุญุงููุ ุชุทููุฑ ุฎุทุฉ ุงูุนููุ ุชูููุฐ ุงููุจุงุฏุฑุงุช.

    ุงููููุฌูุฉ ุงูููุชุฑุญุฉ:
    - ูุณุชุฎุฏู ูููุฌูุฉ ูุฑูุฉ ุชุฑุชูุฒ ุนูู ูุฑุงุญู ุชุญูููุ ุชุตูููุ ุชูููุฐุ ููุชุงุจุนุฉ.

    ุงูุฎุทุฉ ุงูุฒูููุฉ:
    - ูุฏุฉ ุงููุดุฑูุน ุงูููุชุฑุญุฉ 6-8 ุฃุณุงุจูุน.

    ูุฎุฑุฌุงุช ุงููุดุฑูุน:
    - ุชูุงุฑูุฑ ุชุญูููุ ูุซุงุฆู ุงุณุชุฑุงุชูุฌูุฉุ ููุงุฐุฌ ุชุดุบูููุฉุ ูุชูุตูุงุช ููุงุฆูุฉ.

    ุงููุฑูู ุงูููุชุฑุญ:
    - ูุฑูู ูุถู ุฎุจุฑุงุก ูู ุงูุฐูุงุก ุงูุงุตุทูุงุนูุ ุงูุชุญูู ุงูุฑูููุ ูุงูุฅุฏุงุฑุฉ.

    ุงูููุงุญู:
    - ุงูุณูุฑุฉ ุงูุฐุงุชูุฉ ูููุฑููุ ุฃูุซูุฉ ูู ุฃุนูุงู ุณุงุจูุฉุ ูุฃู ูุชุทูุจุงุช ุฅุถุงููุฉ.
    """)
    return template

if st.button("๐ ุชูููุฏ ุงูุนุฑุถ ุงูููู"):
    if uploaded_file and project_name and client_name:
        with st.spinner("๐ ุฌุงุฑู ูุฑุงุกุฉ ุงููุฑุงุณุฉ ูุชุญููููุง..."):
            extracted_text = extract_text_from_pdf(uploaded_file)
            proposal_text = generate_proposal(extracted_text, project_name, client_name)

        doc = Document()
        doc.add_heading(f"ุงูุนุฑุถ ุงูููู ููุดุฑูุน {project_name}", level=1)
        doc.add_paragraph(f"ุงูุฌูุฉ: {client_name}")

        for section in proposal_text.split("\n\n"):
            lines = section.strip().split("\n", 1)
            if len(lines) == 2:
                title, content = lines
                doc.add_heading(title.strip(), level=2)
                doc.add_paragraph(content.strip())
            else:
                doc.add_paragraph(section.strip())

        with tempfile.NamedTemporaryFile(delete=False, suffix=".docx") as tmp:
            doc.save(tmp.name)
            tmp_path = tmp.name

        with open(tmp_path, "rb") as f:
            st.download_button("๐ฅ ุชุญููู ุงูุนุฑุถ ุงูููู (Word)", f, file_name=f"ุนุฑุถ_ููู_{project_name}.docx")

        st.success("โ ุชู ุชูููุฏ ุงูุนุฑุถ ุงูููู ุจูุฌุงุญ!")
    else:
        st.error("ูุฑุฌู ุชุนุจุฆุฉ ุฌููุน ุงูุญููู ุงููุทููุจุฉ.")
